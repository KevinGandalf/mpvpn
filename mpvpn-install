#!/bin/bash

set -e

check_and_disable_ufw() {
    if command -v ufw >/dev/null 2>&1; then
        echo "ğŸ› ï¸  Deaktiviere ufw..."
        systemctl stop ufw || true
        systemctl disable ufw || true
        ufw disable || true
    else
        echo "â„¹ï¸  ufw ist nicht installiert oder nicht aktiv."
    fi
}

check_and_disable_firewalld() {
    if systemctl is-active --quiet firewalld; then
        echo "ğŸ› ï¸  Deaktiviere firewalld..."
        systemctl stop firewalld
        systemctl disable firewalld
    else
        echo "â„¹ï¸  firewalld ist nicht aktiv oder nicht installiert."
    fi
}

check_iproute2() {
    if ! command -v ip >/dev/null 2>&1; then
        echo "âš ï¸  iproute2 fehlt. Versuche Installation..."
        case "$DISTRO" in
            debian|ubuntu) apt install -y iproute2 ;;
            fedora|rocky|centos|almalinux) dnf install -y iproute ;;
            arch) pacman -S --noconfirm iproute2 ;;
            opensuse) zypper install -y iproute2 ;;
            *) echo "âŒ iproute2 konnte nicht automatisch installiert werden." ;;
        esac
    fi
}

install_common_tools_debian() {
    apt update && apt upgrade -y && apt install -y curl wget git iptables net-tools nano rsyslog jq dnsutils dialog wireguard-tools bc
}

install_common_tools_rpm() {
    dnf update && dnf upgrade - && dnf install -y curl wget git iptables net-tools nano rsyslog jq bind-utils dialog wireguard-tools bc
}

install_common_tools_arch() {
    pacman -S --noconfirm curl wget git iptables net-tools nano syslog-ng jq bind-tools dialog wireguard-tools bc
}

install_common_tools_suse() {
    zypper install -y curl wget git iptables net-tools nano syslog-ng jq bind-utils dialog wireguard-tools bc
}

install_iptables_alternative_debian() {
    if ! dpkg -s iptables-persistent >/dev/null 2>&1; then
        echo "âš ï¸  iptables-persistent fehlt."
        read -p "Installiere iptables-persistent? (y/n): " confirm && [[ "$confirm" == "y" ]] && apt install -y iptables-persistent
    fi
}

install_iptables_alternative_rpm() {
    if ! rpm -q iptables-services >/dev/null 2>&1; then
        echo "âš ï¸  iptables-services fehlt."
        read -p "Installiere iptables-services? (y/n): " confirm && [[ "$confirm" == "y" ]] && dnf install -y iptables-services
    fi
}

install_epel_if_needed() {
    if [[ "$DISTRO" =~ ^(rocky|centos|almalinux)$ ]]; then
        if ! rpm -q epel-release >/dev/null 2>&1; then
            echo "ğŸ› ï¸  Installiere EPEL-Repository..."
            dnf install -y epel-release
        fi
    fi
}

install_debian_ubuntu() {
    echo "ğŸ› ï¸  Debian/Ubuntu: Update..."
    apt update && apt upgrade -y
    install_common_tools_debian
    check_iproute2
    install_iptables_alternative_debian

    read -p "MÃ¶chtest du OpenVPN installieren? (y/n): " install_ovpn
    [[ "$install_ovpn" == "y" ]] && apt install -y openvpn

    check_and_disable_ufw
    echo "âœ… Debian/Ubuntu: Fertig."
}

install_fedora() {
    echo "ğŸ› ï¸  Fedora: Update..."
    dnf update -y && dnf upgrade -y
    install_common_tools_rpm
    check_iproute2
    install_iptables_alternative_rpm

    read -p "MÃ¶chtest du OpenVPN installieren? (y/n): " install_ovpn
    [[ "$install_ovpn" == "y" ]] && dnf install -y openvpn

    check_and_disable_firewalld
    echo "âœ… Fedora: Fertig."
}

install_rocky_alma() {
    echo "ğŸ› ï¸  Rocky/CentOS/AlmaLinux: Update..."
    dnf update -y && dnf upgrade -y
    install_epel_if_needed
    install_common_tools_rpm
    check_iproute2
    install_iptables_alternative_rpm

    read -p "MÃ¶chtest du OpenVPN installieren? (y/n): " install_ovpn
    [[ "$install_ovpn" == "y" ]] && dnf install -y openvpn

    check_and_disable_firewalld
    echo "âœ… Rocky/CentOS/AlmaLinux: Fertig."
}

install_arch() {
    echo "ğŸ› ï¸  Arch Linux: Update..."
    pacman -Syu --noconfirm
    install_common_tools_arch
    check_iproute2

    read -p "MÃ¶chtest du OpenVPN installieren? (y/n): " install_ovpn
    [[ "$install_ovpn" == "y" ]] && pacman -S --noconfirm openvpn

    check_and_disable_firewalld
    echo "âœ… Arch Linux: Fertig."
}

install_opensuse() {
    echo "ğŸ› ï¸  openSUSE: Update..."
    zypper update -y
    install_common_tools_suse
    check_iproute2
    install_iptables_alternative_rpm

    read -p "MÃ¶chtest du OpenVPN installieren? (y/n): " install_ovpn
    [[ "$install_ovpn" == "y" ]] && zypper install -y openvpn

    check_and_disable_firewalld
    echo "âœ… openSUSE: Fertig."
}

detect_distro() {
    source /etc/os-release
    DISTRO=$(echo "$ID" | tr '[:upper:]' '[:lower:]')
}

kernel_upgrade_prompt() {
    echo ""
    read -p "ğŸ”§ Kernel-Upgrade auf 6.x ausfÃ¼hren? (y/n): " upgrade_kernel
    if [[ "$upgrade_kernel" == "y" ]]; then
        echo "ğŸš€ Starte Kernel-Upgrade..."
        bash /opt/mpvpn/helperscripts/misc/kernel_upgrade.sh || echo "âš ï¸  Kernel-Upgrade fehlgeschlagen."
        read -p "ğŸ” Jetzt neu starten? (y/n): " reboot_now
        [[ "$reboot_now" == "y" ]] && reboot
    fi
}

main() {
    detect_distro
    case "$DISTRO" in
        debian|ubuntu|rasbian) install_debian_ubuntu ;;
        fedora) install_fedora ;;
        rocky|centos|almalinux) install_rocky_alma ;;
        arch) install_arch ;;
        opensuse*) install_opensuse ;;
        *)
            echo "âŒ Distribution '$DISTRO' wird nicht unterstÃ¼tzt."
            exit 1
            ;;
    esac

    kernel_upgrade_prompt
}

main

# ZusÃ¤tzliche Einrichtung: Root-Passwort setzen, Repository klonen, installieren
echo "ğŸ” Setze Root-Passwort (du wirst jetzt zur Eingabe aufgefordert)..."
sudo passwd

echo "ğŸ” Wechsle zu Root-Shell fÃ¼r Setup..."
sudo su - <<EOF

echo "ğŸ“‚ Wechsel in /opt..."
cd /opt

echo "â¬‡ï¸  Klone mpvpn-Repository..."
git clone https://github.com/KevinGandalf/mpvpn

echo "ğŸ“ Wechsle in /opt/mpvpn..."
cd /opt/mpvpn

echo "ğŸ”§ Setze AusfÃ¼hrungsrechte fÃ¼r alle .sh-Dateien..."
find /opt/mpvpn -type f -name "*.sh" -exec chmod +x {} \;

echo "ğŸ”— Erstelle Symlink /usr/local/bin/mpvpn..."
ln -s /opt/mpvpn/helperscripts/assets/menu.sh /usr/local/bin/mpvpn

echo "ğŸš€ Starte mpvpn --install..."
mpvpn --install

# Wie geht es weiter FAQ
echo ""
echo "ğŸ”§ Wie geht es weiter? - FAQ"
echo "----------------------------------"
echo "1. **VPN-Profile hinzufÃ¼gen**"
echo "   - Um ein **WireGuard** VPN hinzuzufÃ¼gen, fÃ¼hre den folgenden Befehl aus:"
echo "     mpvpn --addwg"
echo "   - Um ein **OpenVPN** hinzuzufÃ¼gen, verwende diesen Befehl:"
echo "     mpvpn --addovpn"
echo ""
echo "2. **Konfigurationsdatei bearbeiten (globals.sh)**"
echo "   - Ã–ffne die Datei /opt/mpvpn/globals.sh mit einem Texteditor:"
echo "     sudo nano /opt/mpvpn/globals.sh"
echo "   - Bearbeite die Konfiguration, um deine VPN-Verbindungen und Routen festzulegen."
echo ""
echo "3. **VPN-Start**"
echo "   - Starte das VPN nach der Bearbeitung der globals.sh mit:"
echo "     mpvpn --startmpvpn"
echo ""
echo "4. **Weitere Optionen**"
echo "   - Du kannst weitere VPN-Profile und Routen jederzeit hinzufÃ¼gen, indem du die entsprechenden Befehle wie mpvpn --addwg oder mpvpn --addovpn ausfÃ¼hrst."
echo "   - Bearbeite die globals.sh und starte das VPN nach jeder Ã„nderung neu."

# Weitere Hilfe und Dokumentation
echo "ğŸ” Weitere Informationen findest du in der Dokumentation auf GitHub unter:"
echo "   https://github.com/KevinGandalf/mpvpn"
echo "   JOIN DISCORD: https://discord.gg/qXRzXvzJQM"
echo "----------------------------------"

# ENDE
echo "ğŸ‰ Wer anderen eine route grÃ¤bt, hat nen routen-grab-gerÃ¤t oder mpvpn"

EOF

echo "âœ… mpvpn-Installation abgeschlossen!"
